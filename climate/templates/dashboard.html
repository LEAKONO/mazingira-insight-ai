{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - {{ menu_translations.app_name }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1><i class="fas fa-tachometer-alt me-2"></i>Climate Dashboard</h1>
        <p class="text-muted">Real-time climate monitoring and predictions for East Africa</p>
    </div>
    <div class="col-md-4 text-end">
        <button class="btn btn-primary" id="refreshDataBtn">
            <i class="fas fa-sync-alt me-1"></i> Refresh Data
        </button>
    </div>
</div>

<!-- Data Status Indicator -->
<div class="alert alert-{% if has_real_data %}success{% else %}warning{% endif %} d-flex align-items-center mb-4">
    <i class="fas fa-{% if has_real_data %}check-circle{% else %}exclamation-triangle{% endif %} me-3 fa-2x"></i>
    <div>
        <h5 class="alert-heading mb-1">
            {% if has_real_data %}
                <i class="fas fa-check me-1"></i> Real Data Loaded
            {% else %}
                <i class="fas fa-exclamation me-1"></i> Sample Data Displayed
            {% endif %}
        </h5>
        <p class="mb-0">
            {% if has_real_data %}
                Charts show actual weather data from {{ regions_with_data|length }} regions.
                {% if regions_with_data.0.data.timestamp %}
                    Last updated: {{ regions_with_data.0.data.timestamp|timesince }} ago.
                {% endif %}
            {% else %}
                Connect to weather APIs to display real-time climate data.
                Run: <code class="ms-1">python manage.py fetch_weather</code>
            {% endif %}
        </p>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-2">
        <div class="card stat-card">
            <div class="stat-value">{{ temp_stats.avg_temp|floatformat:1 }}°C</div>
            <div class="stat-label">Avg Temp</div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card stat-card">
            <div class="stat-value">{{ temp_stats.max_temp|floatformat:1 }}°C</div>
            <div class="stat-label">Max Temp</div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card stat-card">
            <div class="stat-value">{{ temp_stats.min_temp|floatformat:1 }}°C</div>
            <div class="stat-label">Min Temp</div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card stat-card">
            <div class="stat-value">
                {% if wind_stats.avg_wind %}
                    {{ wind_stats.avg_wind|floatformat:1 }}
                {% else %}
                    0
                {% endif %} m/s
            </div>
            <div class="stat-label">Avg Wind</div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card stat-card">
            <div class="stat-value">{{ regions_with_data|length }}</div>
            <div class="stat-label">Regions</div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card stat-card">
            <div class="stat-value">
                {% if rain_stats.total_rainfall %}
                    {{ rain_stats.total_rainfall|floatformat:1 }}
                {% else %}
                    0
                {% endif %} mm
            </div>
            <div class="stat-label">Total Rain</div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-thermometer-half me-2"></i>
                {% if has_real_data %}
                    Temperature Trends (Real Data)
                {% else %}
                    Sample: Temperature Pattern
                {% endif %}
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 400px;">
                    <canvas id="temperatureChart"></canvas>
                </div>
                {% if not has_real_data %}
                <div class="alert alert-info mt-3">
                    <small>
                        <i class="fas fa-info-circle me-1"></i>
                        This shows typical monthly temperature patterns for East Africa.
                        Run <code>python manage.py fetch_weather</code> to collect real data.
                    </small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-wind me-2"></i>
                {% if has_real_data %}
                    Current Wind Speed by Region
                {% else %}
                    Sample: Regional Wind Comparison
                {% endif %}
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 400px;">
                    <canvas id="windChart"></canvas>
                </div>
                {% if not has_real_data %}
                <div class="alert alert-info mt-3">
                    <small>
                        <i class="fas fa-info-circle me-1"></i>
                        This shows typical wind speed variations across East African cities.
                    </small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- MONTHLY TRENDS CHART - NEW ENHANCED SECTION -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-calendar-alt me-2"></i>
                    Monthly Temperature Trends & 12-Month ML Forecast
                </div>
                <div>
                    <span class="badge bg-success me-2">
                        <i class="fas fa-brain me-1"></i> ML Model R²: 0.807
                    </span>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshMonthlyPredictions()">
                        <i class="fas fa-sync-alt me-1"></i> Refresh Forecast
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-9">
                        <div class="chart-container" style="height: 500px;">
                            <canvas id="monthlyTrendsChart"></canvas>
                        </div>
                        <div class="mt-3 text-muted small">
                            <i class="fas fa-info-circle me-1"></i>
                            <strong>Chart shows:</strong> Historical monthly averages (2023-2025) + ML predictions for 2026.
                            Prediction confidence intervals show ±0.5-1.5°C range.
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="trend-analysis p-3 border rounded">
                            <h6><i class="fas fa-chart-line me-2"></i>Trend Analysis</h6>
                            <div class="mt-3">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Current Trend:</span>
                                    <span class="badge bg-{% if monthly_trends.trend == 'increasing' %}danger{% elif monthly_trends.trend == 'decreasing' %}primary{% else %}secondary{% endif %}">
                                        {{ monthly_trends.trend|title }}
                                    </span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Change:</span>
                                    <span>{{ monthly_trends.trend_magnitude|floatformat:1 }}°C</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Data Points:</span>
                                    <span>{{ monthly_trends.total_months }} months</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Historical:</span>
                                    <span>{{ monthly_trends.historical_count }} months</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Forecast:</span>
                                    <span>{{ monthly_trends.prediction_count }} months</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">ML Accuracy:</span>
                                    <span class="badge bg-success">81%</span>
                                </div>
                            </div>
                            
                            <div class="alert alert-info mt-4 p-2 small">
                                <i class="fas fa-lightbulb me-1"></i>
                                <strong>Insight:</strong> 
                                {% if monthly_trends.trend == 'increasing' %}
                                Temperatures show a warming trend for 2026.
                                {% elif monthly_trends.trend == 'decreasing' %}
                                Temperatures show a cooling trend for 2026.
                                {% else %}
                                Temperatures remain stable for 2026.
                                {% endif %}
                            </div>
                            
                            <div class="mt-3">
                                <h6 class="small"><i class="fas fa-legend me-1"></i>Chart Legend</h6>
                                <div class="small">
                                    <div class="d-flex align-items-center mb-1">
                                        <div class="legend-color bg-primary" style="width: 12px; height: 12px; margin-right: 8px;"></div>
                                        <span>Historical Data</span>
                                    </div>
                                    <div class="d-flex align-items-center mb-1">
                                        <div class="legend-color bg-warning" style="width: 12px; height: 12px; margin-right: 8px;"></div>
                                        <span>ML Predictions</span>
                                    </div>
                                    <div class="d-flex align-items-center mb-1">
                                        <div class="legend-color bg-warning opacity-25" style="width: 12px; height: 12px; margin-right: 8px;"></div>
                                        <span>Confidence Interval</span>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <div class="legend-color bg-danger" style="width: 3px; height: 12px; margin-right: 8px;"></div>
                                        <span>Current Month</span>
                                    </div>
                                </div>
                            </div>
                            
                            {% if not monthly_trends.has_predictions %}
                            <div class="alert alert-warning mt-3 p-2 small">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                <strong>No ML predictions available yet.</strong><br>
                                <button class="btn btn-sm btn-outline-primary mt-2 w-100" onclick="generateMonthlyPredictions()">
                                    <i class="fas fa-brain me-1"></i> Generate Predictions
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Data & Predictions -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-map-marker-alt me-2"></i>Latest Climate Data by Region
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead>
                            <tr>
                                <th>Region</th>
                                <th>Temperature</th>
                                <th>Humidity</th>
                                <th>Rainfall</th>
                                <th>Wind Speed</th>
                                <th>Pressure</th>
                                <th>Condition</th>
                                <th>Updated</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for region_data in regions_with_data %}
                            <tr>
                                <td>
                                    <strong>{{ region_data.region.name }}</strong><br>
                                    <small class="text-muted">{{ region_data.region.country }}</small>
                                </td>
                                <td>
                                    <span class="badge {% if region_data.data.temperature > 30 %}bg-danger{% elif region_data.data.temperature > 25 %}bg-warning{% else %}bg-primary{% endif %}">
                                        {{ region_data.data.temperature|floatformat:1 }}°C
                                    </span>
                                </td>
                                <td>
                                    <span class="badge {% if region_data.data.humidity > 80 %}bg-info{% elif region_data.data.humidity > 60 %}bg-primary{% else %}bg-secondary{% endif %}">
                                        {{ region_data.data.humidity|floatformat:0 }}%
                                    </span>
                                </td>
                                <td>
                                    {% if region_data.data.rainfall == 0 %}
                                        <span class="text-muted">0 mm</span>
                                    {% elif region_data.data.rainfall < 2.5 %}
                                        <span class="badge bg-info">
                                            <i class="fas fa-cloud-rain me-1"></i>
                                            {{ region_data.data.rainfall|floatformat:1 }} mm
                                        </span>
                                    {% elif region_data.data.rainfall < 7.6 %}
                                        <span class="badge bg-primary">
                                            <i class="fas fa-cloud-showers-heavy me-1"></i>
                                            {{ region_data.data.rainfall|floatformat:1 }} mm
                                        </span>
                                    {% else %}
                                        <span class="badge bg-danger">
                                            <i class="fas fa-poo-storm me-1"></i>
                                            {{ region_data.data.rainfall|floatformat:1 }} mm
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if region_data.data.wind_speed == 0 %}
                                        <span class="text-muted">Calm</span>
                                    {% elif region_data.data.wind_speed < 5.5 %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-wind me-1"></i>
                                            {{ region_data.data.wind_speed|floatformat:1 }} m/s
                                        </span>
                                    {% elif region_data.data.wind_speed < 13.9 %}
                                        <span class="badge bg-warning">
                                            <i class="fas fa-wind me-1"></i>
                                            {{ region_data.data.wind_speed|floatformat:1 }} m/s
                                        </span>
                                    {% else %}
                                        <span class="badge bg-danger">
                                            <i class="fas fa-wind me-1"></i>
                                            {{ region_data.data.wind_speed|floatformat:1 }} m/s
                                        </span>
                                    {% endif %}
                                    {% if region_data.data.wind_direction %}
                                    <br>
                                    <small class="text-muted">
                                        <i class="fas fa-location-arrow" style="transform: rotate({{ region_data.data.wind_direction|add:"-90" }}deg);"></i>
                                        {{ region_data.data.wind_direction }}°
                                    </small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if region_data.data.pressure %}
                                    <span class="badge bg-secondary">
                                        {{ region_data.data.pressure|floatformat:0 }} hPa
                                    </span>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if region_data.data.temperature > 25 and region_data.data.rainfall == 0 %}
                                        <i class="fas fa-sun text-warning" title="Sunny"></i>
                                    {% elif region_data.data.rainfall > 0 %}
                                        <i class="fas fa-cloud-rain text-primary" title="Rainy"></i>
                                    {% elif region_data.data.humidity > 80 %}
                                        <i class="fas fa-cloud text-secondary" title="Cloudy/Humid"></i>
                                    {% else %}
                                        <i class="fas fa-cloud-sun text-info" title="Partly Cloudy"></i>
                                    {% endif %}
                                    <small class="ms-1">{{ region_data.summary }}</small>
                                </td>
                                <td>
                                    <small class="text-muted">{{ region_data.data.timestamp|timesince }} ago</small>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="8" class="text-center">
                                    <div class="py-4">
                                        <i class="fas fa-cloud-sun fa-2x text-muted mb-3"></i>
                                        <p>No climate data available</p>
                                        <button class="btn btn-sm btn-primary" id="fetchDataBtn">
                                            <i class="fas fa-sync-alt me-1"></i> Fetch Weather Data
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-chart-line me-2"></i>Temperature Predictions
            </div>
            <div class="card-body">
                {% if predictions %}
                <div class="list-group">
                    {% for prediction in predictions %}
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">{{ prediction.region.name }}</h6>
                                <small class="text-muted">
                                    {{ prediction.prediction_date|date:"M d, Y" }}
                                </small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-primary fs-6">
                                    {{ prediction.predicted_temperature|floatformat:1 }}°C
                                </span>
                                {% if prediction.temperature_lower and prediction.temperature_upper %}
                                <div class="text-muted" style="font-size: 0.8rem;">
                                    {{ prediction.temperature_lower|floatformat:1 }}°C - {{ prediction.temperature_upper|floatformat:1 }}°C
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% if prediction.predicted_rainfall > 0 %}
                        <small class="text-muted">
                            <i class="fas fa-cloud-rain me-1"></i>
                            Expected rainfall: {{ prediction.predicted_rainfall|floatformat:1 }} mm
                        </small>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                    <p>No predictions available yet.</p>
                    <button class="btn btn-sm btn-outline-primary" id="generatePredictionsBtn">
                        Generate Predictions
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Wind Status Card -->
        <div class="card mt-4">
            <div class="card-header">
                <i class="fas fa-wind me-2"></i>Current Wind Status
            </div>
            <div class="card-body">
                <div class="text-center">
                    {% if wind_stats.avg_wind %}
                    <div class="display-4 mb-2">
                        {{ wind_stats.avg_wind|floatformat:1 }}<small class="fs-6">m/s</small>
                    </div>
                    {% else %}
                    <div class="display-4 mb-2">
                        0<small class="fs-6">m/s</small>
                    </div>
                    {% endif %}
                    
                    <div class="mb-3">
                        {% if wind_stats.avg_wind < 0.5 %}
                        <span class="badge bg-success">Calm</span>
                        <p class="text-muted small mt-2">Wind is calm, good for outdoor activities</p>
                        {% elif wind_stats.avg_wind < 5.5 %}
                        <span class="badge bg-info">Light Breeze</span>
                        <p class="text-muted small mt-2">Pleasant wind conditions</p>
                        {% elif wind_stats.avg_wind < 13.9 %}
                        <span class="badge bg-warning">Moderate Wind</span>
                        <p class="text-muted small mt-2">Be cautious with light objects</p>
                        {% else %}
                        <span class="badge bg-danger">Strong Wind</span>
                        <p class="text-muted small mt-2">Take precautions outdoors</p>
                        {% endif %}
                    </div>
                    
                    {% if wind_stats.max_wind_region %}
                    <div class="alert alert-warning small">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        <strong>Highest Wind:</strong> {{ wind_stats.max_wind_region }} ({{ wind_stats.max_wind|floatformat:1 }} m/s)
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Carbon Footprint Quick View -->
        {% if user_footprint %}
        <div class="card mt-4">
            <div class="card-header">
                <i class="fas fa-leaf me-2"></i>Your Carbon Footprint
            </div>
            <div class="card-body">
                <div class="text-center">
                    <h3>{{ user_footprint.total_co2e|floatformat:0 }} kg CO₂e</h3>
                    <p class="text-muted">Per year</p>
                    
                    {% with emission_level=user_footprint.get_emission_level %}
                    <span class="badge bg-{% if emission_level == 'Low' %}success{% elif emission_level == 'Moderate' %}warning{% else %}danger{% endif %} p-2 mb-3">
                        {{ emission_level }} Emission Level
                    </span>
                    {% endwith %}
                    
                    <div class="progress mb-3" style="height: 20px;">
                        <div class="progress-bar bg-success" style="width: 25%">Transport</div>
                        <div class="progress-bar bg-warning" style="width: 30%">Electricity</div>
                        <div class="progress-bar bg-primary" style="width: 35%">Diet</div>
                        <div class="progress-bar bg-secondary" style="width: 10%">Waste</div>
                    </div>
                    
                    <a href="{% url 'carbon_calculator' %}" class="btn btn-sm btn-outline-primary">
                        Update Calculation
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Environmental Reports -->
<div class="card">
    <div class="card-header">
        <i class="fas fa-flag me-2"></i>Recent Environmental Reports
    </div>
    <div class="card-body">
        {% if recent_reports %}
        <div class="row">
            {% for report in recent_reports %}
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <span class="badge {% if report.report_type == 'flood' %}bg-primary{% elif report.report_type == 'drought' %}bg-warning{% elif report.report_type == 'pollution' %}bg-danger{% else %}bg-secondary{% endif %} mb-2">
                            {{ report.get_report_type_display }}
                        </span>
                        <h6 class="card-title">{{ report.title }}</h6>
                        <p class="card-text text-muted small">{{ report.description|truncatechars:100 }}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="fas fa-map-marker-alt me-1"></i>
                                {{ report.region.name }}
                            </small>
                            <small class="text-muted">
                                {{ report.created_at|timesince }} ago
                            </small>
                        </div>
                    </div>
                    <div class="card-footer bg-transparent">
                        <a href="{% url 'report_detail' report.id %}" class="btn btn-sm btn-outline-primary">
                            View Details
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="fas fa-flag fa-3x text-muted mb-3"></i>
            <p>No environmental reports yet.</p>
            <a href="{% url 'create_report' %}" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i> Submit Report
            </a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Load Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.0.1/dist/chartjs-plugin-annotation.min.js"></script>

<script>
    // ===========================================
    // DASHBOARD-SPECIFIC CHART CODE
    // ===========================================
    
    // Get REAL data from Django template variables
    const temperatureLabels = {{ temperature_labels|safe }};
    const temperatureData = {{ temperature_data|safe }};
    const temperaturePredictions = {{ temperature_predictions|safe }};
    const windLabels = {{ wind_labels|safe }};
    const windData = {{ wind_data|safe }};
    const hasRealData = {{ has_real_data|yesno:"true,false" }};
    const dataSource = '{{ data_source }}';
    
    console.log('Dashboard loaded with:', {
        dataSource: dataSource,
        temperaturePoints: temperatureData.length,
        windPoints: windData.length,
        hasRealData: hasRealData
    });

    // Initialize charts with REAL data
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Dashboard DOM loaded, initializing REAL charts...');
        
        // Override climateCharts to prevent it from running on dashboard
        window.climateCharts = {
            initializeAllCharts: function() {
                console.log('Climate charts disabled for dashboard - using dashboard-specific charts');
            }
        };
        
        // Initialize our REAL charts
        initializeDashboardCharts();
        
        // Setup event listeners
        setupDashboardEvents();
    });
    
    function initializeDashboardCharts() {
        console.log('Initializing dashboard charts...');
        
        // Destroy any existing charts first
        destroyExistingCharts();
        
        // Create new charts with real data
        createTemperatureChart();
        createWindChart();
        createMonthlyTrendsChart();  // NEW: Monthly trends chart
    }
    
    function destroyExistingCharts() {
        const tempCtx = document.getElementById('temperatureChart');
        const windCtx = document.getElementById('windChart');
        const monthlyCtx = document.getElementById('monthlyTrendsChart');
        
        if (tempCtx && tempCtx.chart) {
            console.log('Destroying existing temperature chart');
            tempCtx.chart.destroy();
            tempCtx.chart = null;
        }
        
        if (windCtx && windCtx.chart) {
            console.log('Destroying existing wind chart');
            windCtx.chart.destroy();
            windCtx.chart = null;
        }
        
        if (monthlyCtx && monthlyCtx.chart) {
            console.log('Destroying existing monthly trends chart');
            monthlyCtx.chart.destroy();
            monthlyCtx.chart = null;
        }
    }
    
    function createTemperatureChart() {
        const tempCtx = document.getElementById('temperatureChart');
        if (!tempCtx) {
            console.error('Temperature chart canvas not found');
            return;
        }
        
        try {
            console.log('Creating temperature chart with REAL data');
            
            // Prepare datasets
            const datasets = [{
                label: hasRealData ? 'Temperature (°C)' : 'Sample Temperature (°C)',
                data: temperatureData,
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.3,
                pointRadius: 4,
                pointHoverRadius: 6
            }];
            
            // Add predictions if available
            const hasPredictions = temperaturePredictions && temperaturePredictions.some(p => p !== null);
            if (hasPredictions) {
                datasets.push({
                    label: 'Predicted Temperature (°C)',
                    data: temperaturePredictions,
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.3,
                    pointRadius: 4,
                    pointHoverRadius: 6
                });
            }
            
            const temperatureChart = new Chart(tempCtx, {
                type: 'line',
                data: {
                    labels: temperatureLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 12
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: hasRealData ? 
                                'Temperature Trends (Real Data)' : 
                                'Sample: Temperature Pattern',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    if (value === 0 && !hasRealData) {
                                        return `${context.dataset.label}: Sample data`;
                                    }
                                    return `${context.dataset.label}: ${value}°C`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: Math.min(...temperatureData.filter(v => v > 0)) - 5 || 15,
                            max: Math.max(...temperatureData) + 5 || 30,
                            title: {
                                display: true,
                                text: 'Temperature (°C)',
                                font: {
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '°C';
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time',
                                font: {
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                }
            });
            
            console.log('Temperature chart created successfully');
            window.temperatureChart = temperatureChart;
            
        } catch (e) {
            console.error('Error creating temperature chart:', e);
            createFallbackTemperatureChart();
        }
    }
    
    function createWindChart() {
        const windCtx = document.getElementById('windChart');
        if (!windCtx) {
            console.error('Wind chart canvas not found');
            return;
        }
        
        try {
            console.log('Creating wind chart with REAL data');
            
            // Color bars based on wind speed
            const colors = windData.map(speed => {
                if (speed < 2) return 'rgba(54, 162, 235, 0.7)'; // Calm
                if (speed < 4) return 'rgba(75, 192, 192, 0.7)'; // Light
                return 'rgba(255, 159, 64, 0.7)'; // Moderate/Strong
            });
            
            const windChart = new Chart(windCtx, {
                type: 'bar',
                data: {
                    labels: windLabels,
                    datasets: [{
                        label: hasRealData ? 'Wind Speed (m/s)' : 'Sample Wind Speed (m/s)',
                        data: windData,
                        backgroundColor: colors,
                        borderColor: colors.map(c => c.replace('0.7', '1')),
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: hasRealData ? 
                                'Current Wind Speed by Region' : 
                                'Sample: Regional Wind Comparison',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const speed = context.parsed.y;
                                    let desc = '';
                                    if (speed < 2) desc = ' (Calm)';
                                    else if (speed < 4) desc = ' (Light Breeze)';
                                    else desc = ' (Moderate Wind)';
                                    return `${speed} m/s${desc}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: Math.max(...windData) + 2 || 6,
                            title: {
                                display: true,
                                text: 'Wind Speed (m/s)',
                                font: {
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + ' m/s';
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Region',
                                font: {
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                maxRotation: 45
                            }
                        }
                    }
                }
            });
            
            console.log('Wind chart created successfully');
            window.windChart = windChart;
            
        } catch (e) {
            console.error('Error creating wind chart:', e);
            createFallbackWindChart();
        }
    }
    
    // Monthly Trends Chart
    function createMonthlyTrendsChart() {
        const monthlyCtx = document.getElementById('monthlyTrendsChart');
        if (!monthlyCtx) {
            console.error('Monthly trends chart canvas not found');
            return;
        }
        
        try {
            console.log('Creating monthly trends chart...');
            
            // Get data from template variables (you'll need to pass these)
            const monthlyLabels = {{ monthly_trends.labels|safe|default:"[]" }};
            const actualTemps = {{ monthly_trends.actual_temperatures|safe|default:"[]" }};
            const predictedTemps = {{ monthly_trends.predicted_temperatures|safe|default:"[]" }};
            const confMin = {{ monthly_trends.confidence_min|safe|default:"[]" }};
            const confMax = {{ monthly_trends.confidence_max|safe|default:"[]" }};
            const currentMonthIdx = {{ monthly_trends.current_month_index|default:"0" }};
            
            // If no data provided, create sample data
            if (monthlyLabels.length === 0) {
                console.log('No monthly trends data provided, creating sample chart');
                createSampleMonthlyTrendsChart(monthlyCtx);
                return;
            }
            
            // Create datasets
            const datasets = [];
            
            // Actual temperatures (historical)
            if (actualTemps.some(t => t !== null)) {
                datasets.push({
                    label: 'Historical Temperature (°C)',
                    data: actualTemps,
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.3,
                    pointRadius: 4,
                    pointHoverRadius: 6
                });
            }
            
            // Predicted temperatures (future)
            if (predictedTemps.some(t => t !== null)) {
                datasets.push({
                    label: 'ML Forecast (°C)',
                    data: predictedTemps,
                    borderColor: 'rgb(255, 159, 64)',
                    backgroundColor: 'rgba(255, 159, 64, 0.1)',
                    borderWidth: 3,
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.3,
                    pointRadius: 4,
                    pointHoverRadius: 6
                });
                
                // Confidence interval
                if (confMin.some(t => t !== null) && confMax.some(t => t !== null)) {
                    datasets.push({
                        label: 'Confidence Interval',
                        data: confMax,
                        borderColor: 'rgba(255, 159, 64, 0.2)',
                        backgroundColor: 'rgba(255, 159, 64, 0.1)',
                        borderWidth: 0,
                        fill: '+1',
                        pointRadius: 0,
                        tension: 0.3
                    });
                    
                    datasets.push({
                        label: '',
                        data: confMin,
                        borderColor: 'rgba(255, 159, 64, 0)',
                        backgroundColor: 'rgba(255, 159, 64, 0.1)',
                        borderWidth: 0,
                        fill: false,
                        pointRadius: 0,
                        tension: 0.3
                    });
                }
            }
            
            const monthlyChart = new Chart(monthlyCtx, {
                type: 'line',
                data: {
                    labels: monthlyLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 12
                                },
                                filter: function(item, chart) {
                                    // Hide empty confidence interval legend
                                    return item.text !== '';
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Monthly Temperature Trends with 12-Month ML Forecast',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    if (value === null) return null;
                                    return `${context.dataset.label}: ${value}°C`;
                                }
                            }
                        },
                        annotation: {
                            annotations: {
                                currentMonthLine: {
                                    type: 'line',
                                    xMin: currentMonthIdx,
                                    xMax: currentMonthIdx,
                                    borderColor: 'rgb(255, 99, 132)',
                                    borderWidth: 2,
                                    label: {
                                        content: 'Current Month',
                                        enabled: true,
                                        position: 'start',
                                        backgroundColor: 'rgba(255, 99, 132, 0.8)'
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Temperature (°C)',
                                font: {
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '°C';
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Month',
                                font: {
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                maxRotation: 45,
                                callback: function(value, index, values) {
                                    // Show every 2nd label to avoid crowding
                                    return index % 2 === 0 ? this.getLabelForValue(value) : '';
                                }
                            }
                        }
                    }
                }
            });
            
            console.log('Monthly trends chart created successfully');
            window.monthlyTrendsChart = monthlyChart;
            
        } catch (e) {
            console.error('Error creating monthly trends chart:', e);
            createSampleMonthlyTrendsChart(monthlyCtx);
        }
    }
    
    function createSampleMonthlyTrendsChart(ctx) {
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec',
                       'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const baseTemps = [23.5, 24.1, 23.8, 22.9, 22.2, 21.5, 20.8, 21.1, 22.0, 22.8, 23.2, 23.4];
        const actualTemps = baseTemps.concat(Array(12).fill(null));
        const predictedTemps = baseTemps.slice(0, 6).concat(Array(6).fill(null), baseTemps.map(t => t + 0.5));
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: months,
                datasets: [
                    {
                        label: 'Historical Temperature (°C)',
                        data: actualTemps,
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.3
                    },
                    {
                        label: 'ML Forecast (°C)',
                        data: predictedTemps,
                        borderColor: 'rgb(255, 159, 64)',
                        backgroundColor: 'rgba(255, 159, 64, 0.1)',
                        borderWidth: 3,
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0.3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Sample: Monthly Temperature Trends (Sample Data)',
                        font: {
                            size: 16,
                            weight: 'bold'
                        }
                    }
                },
                scales: {
                    y: {
                        title: {
                            display: true,
                            text: 'Temperature (°C)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Month'
                        }
                    }
                }
            }
        });
    }
    
    // Generate monthly predictions
    function generateMonthlyPredictions() {
        const btn = event.target.closest('button') || event.target;
        const originalText = btn.innerHTML;
        
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Generating...';
        btn.disabled = true;
        
        fetch('/api/generate-monthly-predictions/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Monthly predictions generated:', data);
                
                // Show success message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
                alertDiv.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Success!</strong> Generated ${data.predictions_generated} monthly predictions.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);
                
                // Reload after a delay
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                throw new Error(data.error || 'Failed to generate predictions');
            }
        })
        .catch(error => {
            console.error('Error generating monthly predictions:', error);
            
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
            alertDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Error:</strong> ${error.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);
            
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
    }
    
    // Refresh monthly predictions
    function refreshMonthlyPredictions() {
        const btn = event.target.closest('button') || event.target;
        const originalText = btn.innerHTML;
        
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Refreshing...';
        btn.disabled = true;
        
        fetch('/api/refresh-monthly-predictions/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Monthly predictions refreshed:', data);
                
                // Show success message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
                alertDiv.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Success!</strong> Refreshed ML forecasts for ${data.months_updated} months.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);
                
                // Reload after a delay
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                throw new Error(data.error || 'Failed to refresh predictions');
            }
        })
        .catch(error => {
            console.error('Error refreshing monthly predictions:', error);
            
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
            alertDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Error:</strong> ${error.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);
            
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
    }
    
    function createFallbackTemperatureChart() {
        const tempCtx = document.getElementById('temperatureChart');
        if (tempCtx) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                           'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const sampleData = [23.5, 24.1, 23.8, 22.9, 22.2, 21.5, 
                               20.8, 21.1, 22.0, 22.8, 23.2, 23.4];
            
            new Chart(tempCtx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Sample Temperature (°C)',
                        data: sampleData,
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        borderWidth: 2
                    }]
                }
            });
        }
    }
    
    function createFallbackWindChart() {
        const windCtx = document.getElementById('windChart');
        if (windCtx) {
            const sampleLabels = ['Nairobi', 'Mombasa', 'Kisumu', 'Nakuru', 'Eldoret'];
            const sampleData = [3.2, 4.5, 2.8, 3.1, 2.9];
            
            new Chart(windCtx, {
                type: 'bar',
                data: {
                    labels: sampleLabels,
                    datasets: [{
                        label: 'Sample Wind Speed (m/s)',
                        data: sampleData,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)'
                    }]
                }
            });
        }
    }
    
    function setupDashboardEvents() {
        // Refresh button
        const refreshBtn = document.getElementById('refreshDataBtn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', refreshDashboardData);
        }
        
        // Fetch data button (in empty table)
        const fetchBtn = document.getElementById('fetchDataBtn');
        if (fetchBtn) {
            fetchBtn.addEventListener('click', refreshDashboardData);
        }
        
        // Generate predictions button
        const predictBtn = document.getElementById('generatePredictionsBtn');
        if (predictBtn) {
            predictBtn.addEventListener('click', generateDashboardPredictions);
        }
    }
    
    function refreshDashboardData() {
        const btn = event.target.closest('button') || event.target;
        const originalText = btn.innerHTML;
        
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Fetching Data...';
        btn.disabled = true;
        
        // Show loading state on charts
        if (window.temperatureChart) {
            window.temperatureChart.data.datasets[0].data = temperatureData.map(() => null);
            window.temperatureChart.update('none');
        }
        
        if (window.windChart) {
            window.windChart.data.datasets[0].data = windData.map(() => null);
            window.windChart.update('none');
        }
        
        if (window.monthlyTrendsChart) {
            window.monthlyTrendsChart.data.datasets[0].data = window.monthlyTrendsChart.data.datasets[0].data.map(() => null);
            window.monthlyTrendsChart.update('none');
        }
        
        fetch('/api/weather-data/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log('New data fetched:', data);
            
            // Show success message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
            alertDiv.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                <strong>Success!</strong> New weather data fetched successfully. Refreshing...
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);
            
            // Reload the page to show new data
            setTimeout(() => {
                location.reload();
            }, 1500);
            
        })
        .catch(error => {
            console.error('Error fetching data:', error);
            
            // Show error message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
            alertDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Error:</strong> Failed to fetch new data. ${error.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Add alert after the statistics cards
            const statsRow = document.querySelector('.row.mb-4:nth-of-type(1)');
            if (statsRow) {
                statsRow.parentNode.insertBefore(alertDiv, statsRow.nextSibling);
            }
            
            // Restore button state after delay
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 2000);
        });
    }
    
    function generateDashboardPredictions() {
        const btn = event.target.closest('button') || event.target;
        const originalText = btn.innerHTML;
        
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Generating...';
        btn.disabled = true;
        
        fetch('/api/predict-temperature/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                region_id: 1,
                days_ahead: 7
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Predictions generated:', data);
                
                // Show success message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
                alertDiv.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Success!</strong> Predictions generated for ${data.region}.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);
                
                // Reload after a delay
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                throw new Error(data.error || 'Failed to generate predictions');
            }
        })
        .catch(error => {
            console.error('Error generating predictions:', error);
            
            // Show error message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
            alertDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Error:</strong> ${error.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);
            
            // Restore button
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
    }
    
    // Auto-refresh charts every 5 minutes if we have real data
    if (hasRealData) {
        setInterval(() => {
            console.log('Auto-refreshing dashboard charts...');
            refreshDashboardData();
        }, 5 * 60 * 1000);
    }
</script>
{% endblock %}